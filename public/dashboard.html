<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>لوحة الأدمن</title>

  <style>
    :root{
      --bg:#0b1220; --card:rgba(17,26,46,.72);
      --text:#e8eefc; --muted:#a9b6d6;
      --line:rgba(255,255,255,.10); --radius:20px;
      --good:#22c55e; --bad:#ef4444; --btn:#1f2a44;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Arial;
      background:
        radial-gradient(1200px 600px at 80% -10%, rgba(99,102,241,.22), transparent 60%),
        radial-gradient(900px 450px at 10% 0%, rgba(34,197,94,.14), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    .container{max-width:1200px; margin:0 auto; padding:24px 16px 40px;}
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:14px 16px; border:1px solid var(--line); border-radius:var(--radius);
      background: var(--card); backdrop-filter: blur(10px);
      position: sticky; top: 12px; z-index: 10;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .brand{display:flex; align-items:center; gap:10px}
    .dot{width:10px;height:10px;border-radius:999px;background:var(--good);box-shadow:0 0 0 7px rgba(34,197,94,.12)}
    .who{color:var(--muted); font-size:13px; margin-top:4px}
    .btn{
      background:var(--btn); color:var(--text);
      border:1px solid var(--line);
      padding:10px 12px; border-radius:16px;
      cursor:pointer; font-weight:800; transition:.15s;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.18); }
    .btn.good{ border-color: rgba(34,197,94,.35); }
    .btn.bad{ border-color: rgba(239,68,68,.35); }

    .layout{display:grid; grid-template-columns: 1.15fr .85fr; gap:14px; margin-top:14px;}
    @media (max-width: 980px){ .layout{grid-template-columns:1fr;} }

    .card{
      border:1px solid var(--line); border-radius:var(--radius);
      background: var(--card); backdrop-filter: blur(10px);
      overflow:hidden; box-shadow: 0 10px 30px rgba(0,0,0,.20);
    }
    .card .head{
      padding:14px 16px; border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .card .body{ padding:14px 16px; }

    label{display:block; color:var(--muted); font-size:13px; margin-bottom:6px}
    input, textarea{
      width:100%; padding:12px 14px; border-radius:16px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18); color:var(--text);
      outline:none;
    }
    textarea{ min-height: 110px; resize: vertical; }

    .toolbar{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px}
    .blocks{display:flex; flex-direction:column; gap:10px; margin-top:12px}

    .block{
      border:1px solid var(--line);
      border-radius:16px;
      background: rgba(0,0,0,.16);
      padding:12px;
    }
    .blockTop{display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:10px}
    .tag{font-size:12px; color:var(--muted)}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width: 650px){ .row{grid-template-columns:1fr;} }

    .preview img,.preview video{width:100%; border-radius:16px; border:1px solid var(--line); background:#0b1220}

    .tableWrap{overflow:auto; border:1px solid var(--line); border-radius:16px; margin-top:10px}
    table{width:100%; border-collapse:collapse; min-width:520px}
    th,td{padding:10px 12px; border-bottom:1px solid var(--line); text-align:right}
    th{background:rgba(255,255,255,.04); color:#cfe0ff; font-weight:800}

    .err{
      display:none;
      margin-top:12px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(239,68,68,.35);
      background: rgba(239,68,68,.08);
      color:#ffb4b4;
      font-size:13px;
      line-height:1.6;
    }

    .newsItem{border-top:1px solid var(--line); padding-top:12px; margin-top:12px}
    .meta{color:var(--muted); font-size:12px; margin-top:6px}
  </style>
</head>

<body>
  <div class="container">
    <div class="topbar">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <div style="font-weight:900">لوحة الأدمن</div>
          <div class="who" id="who">...</div>
        </div>
      </div>

      <div style="display:flex; gap:8px; align-items:center">
        <button class="btn" id="refresh">تحديث</button>
        <button class="btn bad" id="logout">تسجيل خروج</button>
      </div>
    </div>

    <div class="layout">
      <!-- Editor -->
      <section class="card">
        <div class="head">
          <div style="font-weight:900">إنشاء خبر (Blocks)</div>
          <button class="btn good" id="publish">نشر الخبر</button>
        </div>

        <div class="body">
          <label>عنوان الخبر</label>
          <input id="title" placeholder="مثال: إطلاق تحديث جديد..." />

          <div class="toolbar">
            <button class="btn" id="addP">+ نص</button>
            <button class="btn" id="addImg">+ صورة</button>
            <button class="btn" id="addVid">+ فيديو</button>
            <button class="btn" id="addTbl">+ جدول</button>
          </div>

          <div class="blocks" id="blocks"></div>
          <div class="err" id="msg"></div>
        </div>
      </section>

      <!-- Manage -->
      <aside class="card">
        <div class="head">
          <div style="font-weight:900">إدارة الأخبار</div>
        </div>
        <div class="body" id="list"></div>
      </aside>
    </div>
  </div>

  <script>
    let blocks = [];

    function showError(text){
      const el = document.getElementById("msg");
      el.textContent = text;
      el.style.display = "block";
    }
    function clearError(){
      const el = document.getElementById("msg");
      el.textContent = "";
      el.style.display = "none";
    }

    async function me(){
      const r = await fetch("/api/admin/me", { credentials:"same-origin" });
      if(r.status === 401){
        location.href="/login.html";
        return;
      }
      const d = await r.json();
      document.getElementById("who").textContent = `مرحباً، ${d.user.username}`;
    }

    function labelOf(t){
      return ({paragraph:"نص", image:"صورة", video:"فيديو", table:"جدول"}[t] || t);
    }

    async function uploadFile(file){
      clearError();
      const fd = new FormData();
      fd.append("file", file);

      const r = await fetch("/api/admin/upload", {
        method:"POST",
        credentials:"same-origin",
        body: fd
      });

      const d = await r.json().catch(()=>({}));
      if(!r.ok){
        showError(d.error || "فشل رفع الملف");
        return null;
      }
      return d;
    }

    function renderBlocks(){
      const root = document.getElementById("blocks");
      root.innerHTML = "";

      blocks.forEach((b, i) => {
        const el = document.createElement("div");
        el.className = "block";

        const top = document.createElement("div");
        top.className = "blockTop";
        top.innerHTML = `
          <div class="tag">${labelOf(b.type)}</div>
          <div style="display:flex; gap:8px">
            <button class="btn" data-act="up">↑</button>
            <button class="btn" data-act="down">↓</button>
            <button class="btn bad" data-act="del">حذف</button>
          </div>
        `;
        top.querySelector('[data-act="del"]').onclick = () => { blocks.splice(i,1); renderBlocks(); };
        top.querySelector('[data-act="up"]').onclick = () => { if(i>0){ [blocks[i-1],blocks[i]]=[blocks[i],blocks[i-1]]; renderBlocks(); } };
        top.querySelector('[data-act="down"]').onclick = () => { if(i<blocks.length-1){ [blocks[i+1],blocks[i]]=[blocks[i],blocks[i+1]]; renderBlocks(); } };

        el.appendChild(top);

        if(b.type === "paragraph"){
          const ta = document.createElement("textarea");
          ta.placeholder = "اكتب النص هنا...";
          ta.value = b.text || "";
          ta.oninput = () => b.text = ta.value;
          el.appendChild(ta);
        }

        if(b.type === "image"){
          const row = document.createElement("div");
          row.className = "row";
          row.innerHTML = `
            <div>
              <label>رفع صورة</label>
              <input type="file" accept="image/*" />
            </div>
            <div>
              <label>أو رابط صورة</label>
              <input placeholder="https://..." value="${escapeAttr(b.url||"")}" />
            </div>
          `;
          const file = row.querySelector('input[type="file"]');
          const url = row.querySelectorAll('input')[1];

          file.onchange = async () => {
            const f = file.files[0];
            if(!f) return;
            const up = await uploadFile(f);
            if(up?.url){ b.url = up.url; renderBlocks(); }
          };
          url.oninput = () => { b.url = url.value; renderBlocks(); };

          el.appendChild(row);

          const prev = document.createElement("div");
          prev.className = "preview";
          prev.innerHTML = b.url ? `<img src="${escapeAttr(b.url)}" alt="">`
                                 : `<div class="tag">لا توجد صورة بعد</div>`;
          el.appendChild(prev);
        }

        if(b.type === "video"){
          const row = document.createElement("div");
          row.className = "row";
          row.innerHTML = `
            <div>
              <label>رفع فيديو (mp4/webm)</label>
              <input type="file" accept="video/mp4,video/webm" />
            </div>
            <div>
              <label>أو رابط فيديو (mp4/webm أو YouTube)</label>
              <input placeholder="https://..." value="${escapeAttr(b.url||"")}" />
            </div>
          `;
          const file = row.querySelector('input[type="file"]');
          const url = row.querySelectorAll('input')[1];

          file.onchange = async () => {
            const f = file.files[0];
            if(!f) return;
            const up = await uploadFile(f);
            if(up?.url){ b.url = up.url; renderBlocks(); }
          };
          url.oninput = () => { b.url = url.value; renderBlocks(); };

          el.appendChild(row);

          const prev = document.createElement("div");
          prev.className = "preview";
          if(!b.url){
            prev.innerHTML = `<div class="tag">لا يوجد فيديو بعد</div>`;
          }else if(isYoutube(b.url)){
            prev.innerHTML = `
              <iframe width="100%" height="360" style="border:0;border-radius:16px"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen src="${escapeAttr(toYoutubeEmbed(b.url))}"></iframe>`;
          }else{
            prev.innerHTML = `<video controls src="${escapeAttr(b.url)}"></video>`;
          }
          el.appendChild(prev);
        }

        if(b.type === "table"){
          if(!Array.isArray(b.headers)) b.headers = ["", ""];
          if(!Array.isArray(b.rows)) b.rows = [["",""],["",""]];

          const rowCtl = document.createElement("div");
          rowCtl.className="row";
          rowCtl.innerHTML = `
            <div>
              <label>عدد الأعمدة</label>
              <input type="number" min="1" max="12" value="${b.headers.length}">
            </div>
            <div>
              <label>عدد الصفوف</label>
              <input type="number" min="1" max="50" value="${b.rows.length}">
            </div>
          `;
          const colIn = rowCtl.querySelectorAll("input")[0];
          const rowIn = rowCtl.querySelectorAll("input")[1];
          colIn.onchange = () => resizeTable(b, Number(colIn.value), Number(rowIn.value));
          rowIn.onchange = () => resizeTable(b, Number(colIn.value), Number(rowIn.value));

          el.appendChild(rowCtl);

          // Edit headers/rows
          const editor = document.createElement("div");
          editor.style.marginTop="10px";

          // headers editor
          const hRow = document.createElement("div");
          hRow.className="row";
          hRow.style.gridTemplateColumns = `repeat(${b.headers.length}, 1fr)`;
          hRow.style.gap = "8px";
          hRow.style.display="grid";

          b.headers.forEach((h, idx) => {
            const inp = document.createElement("input");
            inp.placeholder = `عنوان ${idx+1}`;
            inp.value = h;
            inp.oninput = () => b.headers[idx] = inp.value;
            hRow.appendChild(inp);
          });

          editor.appendChild(hRow);

          // rows editor
          b.rows.forEach((r, rIdx) => {
            const rRow = document.createElement("div");
            rRow.style.display="grid";
            rRow.style.gridTemplateColumns = `repeat(${b.headers.length}, 1fr)`;
            rRow.style.gap="8px";
            rRow.style.marginTop="8px";

            r.forEach((cell, cIdx) => {
              const inp = document.createElement("input");
              inp.placeholder = `R${rIdx+1}C${cIdx+1}`;
              inp.value = cell;
              inp.oninput = () => b.rows[rIdx][cIdx] = inp.value;
              rRow.appendChild(inp);
            });

            editor.appendChild(rRow);
          });

          el.appendChild(editor);

          // Preview table
          const wrap = document.createElement("div");
          wrap.className="tableWrap";
          wrap.innerHTML = buildTableHTML(b.headers, b.rows);
          el.appendChild(wrap);
        }

        root.appendChild(el);
      });
    }

    function resizeTable(b, cols, rows){
      cols = Math.max(1, Math.min(12, cols || 1));
      rows = Math.max(1, Math.min(50, rows || 1));

      while(b.headers.length < cols) b.headers.push("");
      b.headers = b.headers.slice(0, cols);

      while(b.rows.length < rows) b.rows.push(Array(cols).fill(""));
      b.rows = b.rows.slice(0, rows).map(r => {
        r = Array.isArray(r) ? r : [];
        while(r.length < cols) r.push("");
        return r.slice(0, cols);
      });

      renderBlocks();
    }

    function buildTableHTML(headers, rows){
      const th = headers.map(h => `<th>${escapeHtml(h)}</th>`).join("");
      const trs = rows.map(r => `<tr>${r.map(c => `<td>${escapeHtml(c)}</td>`).join("")}</tr>`).join("");
      return `<table><thead><tr>${th}</tr></thead><tbody>${trs}</tbody></table>`;
    }

    async function publish(){
      clearError();
      const title = document.getElementById("title").value.trim();
      if(title.length < 2){ showError("العنوان مطلوب"); return; }
      if(blocks.length === 0){ showError("أضف محتوى قبل النشر"); return; }

      // Validate media blocks
      for(const b of blocks){
        if((b.type === "image" || b.type === "video") && !b.url){
          showError("في بلوك صورة/فيديو بدون رابط أو رفع ملف");
          return;
        }
      }

      const r = await fetch("/api/admin/news", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        credentials:"same-origin",
        body: JSON.stringify({ title, blocks })
      });

      const d = await r.json().catch(()=>({}));
      if(!r.ok){
        showError(d.error || "فشل النشر");
        return;
      }

      // reset
      document.getElementById("title").value = "";
      blocks = [];
      renderBlocks();
      await loadList();
    }

    async function loadList(){
      const list = document.getElementById("list");
      list.innerHTML = "";

      const r = await fetch("/api/admin/news", { credentials:"same-origin" });
      if(r.status === 401){ location.href="/login.html"; return; }
      const d = await r.json();

      const items = d.items || [];
      if(items.length === 0){
        list.innerHTML = `<div class="tag">لا توجد أخبار.</div>`;
        return;
      }

      items.forEach(item => {
        const el = document.createElement("div");
        el.className="newsItem";
        el.innerHTML = `
          <div style="font-weight:900">${escapeHtml(item.title)}</div>
          <div class="meta">${new Date(item.createdAt).toLocaleString("ar-EG")}</div>
          <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap">
            <button class="btn bad">حذف</button>
          </div>
        `;

        el.querySelector("button").onclick = async () => {
          const rr = await fetch(`/api/admin/news/${encodeURIComponent(item.id)}`, {
            method:"DELETE",
            credentials:"same-origin"
          });
          const dd = await rr.json().catch(()=>({}));
          if(!rr.ok){
            showError(dd.error || "فشل الحذف");
            return;
          }
          await loadList();
        };

        list.appendChild(el);
      });
    }

    document.getElementById("addP").onclick = (e) => { e.preventDefault(); blocks.push({type:"paragraph", text:""}); renderBlocks(); };
    document.getElementById("addImg").onclick = (e) => { e.preventDefault(); blocks.push({type:"image", url:"", alt:""}); renderBlocks(); };
    document.getElementById("addVid").onclick = (e) => { e.preventDefault(); blocks.push({type:"video", url:""}); renderBlocks(); };
    document.getElementById("addTbl").onclick = (e) => { e.preventDefault(); blocks.push({type:"table", headers:["",""], rows:[["",""],["",""]]}); renderBlocks(); };

    document.getElementById("publish").onclick = publish;
    document.getElementById("refresh").onclick = loadList;

    document.getElementById("logout").onclick = async () => {
      clearError();
      const r = await fetch("/api/logout", { method:"POST", credentials:"same-origin" });
      if(r.ok) location.href="/login.html";
      else showError("فشل تسجيل الخروج");
    };

    function isYoutube(url){
      return (url||"").includes("youtube.com") || (url||"").includes("youtu.be");
    }
    function toYoutubeEmbed(url){
      try{
        const u = new URL(url);
        if(u.hostname.includes("youtu.be")){
          return `https://www.youtube.com/embed/${u.pathname.replace("/","")}`;
        }
        const id = u.searchParams.get("v");
        return `https://www.youtube.com/embed/${id || ""}`;
      }catch{ return url; }
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
      }[c]));
    }
    function escapeAttr(s){ return escapeHtml(s).replaceAll('"',"&quot;"); }

    (async function init(){
      await me();
      renderBlocks();
      await loadList();
    })();
  </script>
</body>
</html>
